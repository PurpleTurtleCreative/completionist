!function(){"use strict";var e=window.wp.element;const{createContext:t,useState:a}=wp.element,s=t(!1);function n(t){let{children:n}=t;const[l,o]=a(Object.values(window.PTCCompletionist.tasks)),c={tasks:l,setTaskProcessingStatus:(e,t)=>{o((a=>a.map((a=>a.gid==e?{...a,processingStatus:t}:{...a}))))},completeTask:async function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const a=c.tasks.find((t=>e===t.gid));let s={action:"ptc_update_task",nonce:window.PTCCompletionist.api.nonce,task_gid:e,completed:t};const n={method:"POST",credentials:"same-origin",body:new URLSearchParams(s)};return await window.fetch(window.ajaxurl,n).then((e=>e.json())).then((e=>(console.log(e),"success"==e.status&&e.data?(c.updateTask({gid:a.gid,completed:t}),!0):("error"==e.status&&e.data?console.error(e.data):alert("[Completionist] Error "+e.code+": "+e.message),!1)))).catch((e=>(console.error("Promise catch:",e),alert("[Completionist] Failed to complete task."),!1)))},deleteTask:async e=>{const t=c.tasks.find((t=>e===t.gid));let a={action:"ptc_delete_task",nonce:window.PTCCompletionist.api.nonce,task_gid:e};t.action_link.post_id&&(a.post_id=t.action_link.post_id);const s={method:"POST",credentials:"same-origin",body:new URLSearchParams(a)};return await window.fetch(window.ajaxurl,s).then((e=>e.json())).then((e=>(console.log(e),"success"==e.status&&e.data?(c.removeTask(e.data),!0):("error"==e.status&&e.data?console.error(e.data):alert("[Completionist] Error "+e.code+": "+e.message),!1)))).catch((e=>(console.error("Promise catch:",e),alert("[Completionist] Failed to delete task."),!1)))},unpinTask:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;c.tasks.find((t=>e===t.gid));let a={action:"ptc_unpin_task",nonce:window.PTCCompletionist.api.nonce,task_gid:e};t&&(a.post_id=t);const s={method:"POST",credentials:"same-origin",body:new URLSearchParams(a)};return await window.fetch(window.ajaxurl,s).then((e=>e.json())).then((e=>(console.log(e),"success"==e.status&&e.data?(c.removeTask(e.data),!0):("error"==e.status&&e.data?console.error(e.data):alert("[Completionist] Error "+e.code+": "+e.message),!1)))).catch((e=>(console.error("Promise catch:",e),alert("[Completionist] Failed to unpin task."),!1)))},updateTask:e=>{o((t=>t.map((t=>t.gid==e.gid?{...t,...e}:{...t}))))},removeTask:e=>{o((t=>t.map((t=>{if(t.gid!=e)return{...t}})).filter((e=>!!e))))}};return(0,e.createElement)(s.Provider,{value:c},n)}function l(e){return Date.parse(e.due_on)-Date.now()<604800}function o(e){return e.filter((e=>!e.completed))}function c(e){return e.filter((e=>l(e)))}function i(e,t){return t.filter((t=>!!t.assignee&&e===t.assignee.gid))}function r(e){return e.filter((e=>!(e.action_link&&e.action_link.post_id>0)))}function m(e){return e.filter((e=>!!(e.action_link&&e.action_link.post_id>0)))}const{useContext:d,useMemo:u}=wp.element;function p(){const{tasks:t}=d(s),a=u((()=>o(t)),[t]),n=t.length-a.length;let l=0;return t.length>0&&(l=Math.round(n/t.length*100)),(0,e.createElement)("div",{className:"ptc-TaskOverview"},(0,e.createElement)("div",{className:"feature"},(0,e.createElement)("p",{className:"large"},l,(0,e.createElement)("span",{className:"small"},"%")),(0,e.createElement)("p",{className:"caption"},"Complete")),(0,e.createElement)("div",{className:"details"},(0,e.createElement)("p",{className:"incomplete"},(0,e.createElement)("span",{className:"count"},a.length)," Remaining"),(0,e.createElement)("div",{className:"progress"},(0,e.createElement)("div",{className:"progress-bar-wrapper"},(0,e.createElement)("div",{className:"progress-bar",style:{width:`${l}%`}})),(0,e.createElement)("p",{className:"caption"},(0,e.createElement)("span",{className:"completed"},"Completed ",n)," of ",t.length))))}const{useState:k,useCallback:g,useMemo:f,useEffect:E}=wp.element;function w(t){let{tasks:a,onChange:s}=t;const[n,l]=k("none"),d=f((()=>{const e=o(a);return[{key:"none",title:"All Tasks",tasks:e},{key:"pinned",title:"Pinned",tasks:m(e)},{key:"general",title:"General",tasks:r(e)},{key:"myTasks",title:"My Tasks",tasks:i(window.PTCCompletionist.me.gid,e)},{key:"critical",title:"Critical",tasks:c(e)}]}),[a]);E((()=>{const e=d.find((e=>n===e.key)).tasks;s(n,e)}),[d,n,s]);const u=g(((e,t)=>{l(e)}),[l]),p=d.map((t=>{let a=`filter-${t.key}`;return n===t.key&&(a+=" --is-active"),(0,e.createElement)("button",{key:t.key,type:"button",className:a,onClick:()=>u(t.key,t.tasks)},`${t.title} (${t.tasks.length})`)}));return(0,e.createElement)("div",{className:"ptc-TaskFilters"},p)}const{useCallback:C,useContext:h}=wp.element;function N(t){let{taskGID:a,processingStatus:n}=t;const{deleteTask:l,unpinTask:o,removeTask:c,setTaskProcessingStatus:i}=h(s),r=C((e=>{n?console.error(`Rejected handleUnpinTask. Currently ${n} task ${e}.`):(i(e,"unpinning"),o(e).then((t=>{t||i(e,!1)})))}),[n,i,o]),m=C((e=>{n?console.error(`Rejected handleDeleteTask. Currently ${n} task ${e}.`):(i(e,"deleting"),l(e).then((t=>{t||i(e,!1)})))}),[n,i,c]),d=function(e){return`https://app.asana.com/0/0/${e}/f`}(a),u="unpinning"===n?"fa-sync-alt fa-spin":"fa-thumbtack",p="deleting"===n?"fa-sync-alt fa-spin":"fa-minus";return(0,e.createElement)("div",{className:"ptc-TaskActions"},(0,e.createElement)("a",{href:d,target:"_asana"},(0,e.createElement)("button",{title:"View in Asana",className:"view",type:"button"},(0,e.createElement)("i",{className:"fas fa-link"}))),(0,e.createElement)("button",{title:"Unpin from Site",className:"unpin",type:"button",onClick:()=>r(a),disabled:!!n},(0,e.createElement)("i",{className:`fas ${u}`})),(0,e.createElement)("button",{title:"Delete from Asana",className:"delete",type:"button",onClick:()=>m(a),disabled:!!n},(0,e.createElement)("i",{className:`fas ${p}`})))}const{useState:y,useCallback:T,useContext:b}=wp.element;function v(t){let{task:a}=t;const[n,o]=y(!1),{completeTask:c,setTaskProcessingStatus:i}=b(s),r=T((e=>{a.processingStatus?console.error(`Rejected handleMarkComplete. Currently ${a.processingStatus} task ${e}.`):(i(e,"completing"),c(e).then((t=>{i(e,!1)})))}),[a.processingStatus,i,c]),m=T((()=>{a.notes&&o(!n)}),[a,n,o]),d=n?"fas":"far";let u=null;a.assignee&&(u=window.PTCCompletionist.users[a.assignee.gid]?window.PTCCompletionist.users[a.assignee.gid].data.display_name:"(Not Connected)");let p="";l(a)&&(p+=" --is-critical"),!0===a.completed&&(p+=" --is-complete"),a.processingStatus&&(p+=` --is-processing --is-${a.processingStatus}`),a.notes&&(p+=" --has-description");const k="completing"===a.processingStatus?"fa-sync-alt fa-spin":"fa-check",g=new Date(a.due_on).toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric"});return(0,e.createElement)("div",{className:"ptc-TaskRow"+p},(0,e.createElement)("button",{title:"Mark Complete",className:"mark-complete",type:"button",onClick:()=>r(a.gid),disabled:!!a.processingStatus},(0,e.createElement)("i",{className:`fas ${k}`})),(0,e.createElement)("div",{className:"body"},(0,e.createElement)("p",{className:"name",onClick:m},a.name,!!a.notes&&(0,e.createElement)("i",{className:`${d} fa-sticky-note`})),(0,e.createElement)("div",{className:"details"},u&&(0,e.createElement)("p",{className:"assignee"},(0,e.createElement)("i",{class:"fas fa-user"})," ",u),a.due_on&&(0,e.createElement)("p",{className:"due"},(0,e.createElement)("i",{className:"fas fa-clock"})," ",g)),n&&(0,e.createElement)("p",{className:"description"},a.notes)),(0,e.createElement)("div",{className:"actions"},(0,e.createElement)("a",{className:"cta-button",href:a.action_link.href,target:a.action_link.target},a.action_link.label," ",(0,e.createElement)("i",{className:"fas fa-long-arrow-alt-right"})),(0,e.createElement)(N,{taskGID:a.gid,processingStatus:a.processingStatus})))}function P(t){let{tasks:a}=t;const s=a.map((t=>(0,e.createElement)(v,{key:t.gid,task:t})));return(0,e.createElement)("div",{className:"ptc-TaskList"},s)}const{useState:_,useCallback:S,useMemo:$,useEffect:x}=wp.element;function D(t){let{limit:a,tasks:s}=t;const[n,l]=_(1),o=$((()=>Math.ceil(s.length/a)),[s,a]),c=S((e=>{l(e<=1?1:e>=o?o:e)}),[n,l,o]);x((()=>{c(n)}),[s]);const i=Math.max(0,(n-1)*a),r=s.slice(i,n*a),m=[];for(let t=1;t<=o;++t)m.push((0,e.createElement)("button",{className:"num",type:"button",title:`Page ${t}`,disabled:t===n,onClick:()=>c(t)},t));return(0,e.createElement)("div",{className:"ptc-TaskListPaginated"},(0,e.createElement)(P,{tasks:r}),(0,e.createElement)("nav",{className:"pagination"},(0,e.createElement)("button",{className:"prev",type:"button",title:"Previous Page",disabled:1===n,onClick:()=>c(n-1)},(0,e.createElement)("i",{className:"fas fa-angle-left"})),m,(0,e.createElement)("button",{className:"next",type:"button",title:"Next Page",disabled:o===n,onClick:()=>c(n+1)},(0,e.createElement)("i",{className:"fas fa-angle-right"}))),(0,e.createElement)("a",{href:window.PTCCompletionist.tag_url,target:"_asana",className:"view-tag"},(0,e.createElement)("button",{title:"View All Site Tasks in Asana",className:"view",type:"button"},(0,e.createElement)("i",{class:"fas fa-link"}))))}const{useContext:j,useCallback:M,useState:L,useEffect:R}=wp.element;function A(){const{tasks:t}=j(s),[a,n]=L(o(t)),l=M(((e,t)=>n(t)),[]);return(0,e.createElement)("div",{className:"ptc-PTCCompletionistTasksDashboardWidget"},(0,e.createElement)(p,{tasks:t}),(0,e.createElement)(w,{tasks:t,onChange:l}),(0,e.createElement)(D,{limit:5,tasks:a}))}function O(t){let{type:a,message:s,code:n}=t,l=null;"error"===a&&(l="Error",n&&(l+=` ${n}`));let o=null;l&&(o=(0,e.createElement)("strong",null,l+". "));let c="";return a&&(c+=` --has-type-${a}`),(0,e.createElement)("div",{className:"ptc-NoteBox"+c},(0,e.createElement)("p",null,o,s))}const{render:U}=wp.element;document.addEventListener("DOMContentLoaded",(()=>{const t=document.getElementById("ptc-PTCCompletionistTasksDashboardWidget");null!==t&&("error"in window.PTCCompletionist?U((0,e.createElement)(O,{type:"error",message:window.PTCCompletionist.error.message,code:window.PTCCompletionist.error.code}),t):U((0,e.createElement)(n,null,(0,e.createElement)(A,null)),t))}))}();
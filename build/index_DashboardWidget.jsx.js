!function(){"use strict";var e=window.wp.element;const{createContext:t,useState:a}=wp.element,s=t(!1);function n(t){let{children:n}=t;const[l,i]=a(Object.values(window.PTCCompletionist.tasks)),o={tasks:l,setTaskProcessingStatus:(e,t)=>{i((a=>a.map((a=>a.gid==e?{...a,processingStatus:t}:{...a}))))},completeTask:async function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const a=o.tasks.find((t=>e===t.gid));let s={action:"ptc_update_task",nonce:window.PTCCompletionist.api.nonce,task_gid:e,completed:t};const n={method:"POST",credentials:"same-origin",body:new URLSearchParams(s)};return await window.fetch(window.ajaxurl,n).then((e=>e.json())).then((e=>(console.log(e),"success"==e.status&&e.data?(o.updateTask({gid:a.gid,completed:t}),!0):("error"==e.status&&e.data?console.error(e.data):alert("[Completionist] Error "+e.code+": "+e.message),!1)))).catch((e=>(console.error("Promise catch:",e),alert("[Completionist] Failed to complete task."),!1)))},deleteTask:async e=>{const t=o.tasks.find((t=>e===t.gid));let a={action:"ptc_delete_task",nonce:window.PTCCompletionist.api.nonce,task_gid:e};t.action_link.post_id&&(a.post_id=t.action_link.post_id);const s={method:"POST",credentials:"same-origin",body:new URLSearchParams(a)};return await window.fetch(window.ajaxurl,s).then((e=>e.json())).then((e=>(console.log(e),"success"==e.status&&e.data?(o.removeTask(e.data),!0):("error"==e.status&&e.data?console.error(e.data):alert("[Completionist] Error "+e.code+": "+e.message),!1)))).catch((e=>(console.error("Promise catch:",e),alert("[Completionist] Failed to delete task."),!1)))},unpinTask:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;o.tasks.find((t=>e===t.gid));let a={action:"ptc_unpin_task",nonce:window.PTCCompletionist.api.nonce,task_gid:e};t&&(a.post_id=t);const s={method:"POST",credentials:"same-origin",body:new URLSearchParams(a)};return await window.fetch(window.ajaxurl,s).then((e=>e.json())).then((e=>(console.log(e),"success"==e.status&&e.data?(o.removeTask(e.data),!0):("error"==e.status&&e.data?console.error(e.data):alert("[Completionist] Error "+e.code+": "+e.message),!1)))).catch((e=>(console.error("Promise catch:",e),alert("[Completionist] Failed to unpin task."),!1)))},updateTask:e=>{i((t=>t.map((t=>t.gid==e.gid?{...t,...e}:{...t}))))},removeTask:e=>{i((t=>t.map((t=>{if(t.gid!=e)return{...t}})).filter((e=>!!e))))},getTaskUrl:e=>`https://app.asana.com/0/0/${e}/f`,isCriticalTask:e=>Date.parse(e.due_on)-Date.now()<604800,filterIncompleteTasks:e=>e.filter((e=>!e.completed)),filterCriticalTasks:e=>e.filter((e=>o.isCriticalTask(e))),filterMyTasks:(e,t)=>t.filter((t=>!!t.assignee&&e===t.assignee.gid)),filterGeneralTasks:e=>e.filter((e=>!(e.action_link&&e.action_link.post_id>0))),filterPinnedTasks:e=>e.filter((e=>!!(e.action_link&&e.action_link.post_id>0)))};return(0,e.createElement)(s.Provider,{value:o},n)}const{useContext:l,useMemo:i}=wp.element;function o(){const{tasks:t,filterIncompleteTasks:a}=l(s),n=i((()=>a(t)),[t]),o=t.length-n.length;let c=0;return t.length>0&&(c=Math.round(o/t.length*100)),(0,e.createElement)("div",{className:"ptc-TaskOverview"},(0,e.createElement)("div",{className:"feature"},(0,e.createElement)("p",{className:"large"},c,(0,e.createElement)("span",{className:"small"},"%")),(0,e.createElement)("p",{className:"caption"},"Complete")),(0,e.createElement)("div",{className:"details"},(0,e.createElement)("p",{className:"incomplete"},(0,e.createElement)("span",{className:"count"},n.length)," Remaining"),(0,e.createElement)("div",{className:"progress"},(0,e.createElement)("div",{className:"progress-bar-wrapper"},(0,e.createElement)("div",{className:"progress-bar",style:{width:`${c}%`}})),(0,e.createElement)("p",{className:"caption"},(0,e.createElement)("span",{className:"completed"},"Completed ",o)," of ",t.length))))}const{useState:c,useCallback:r,useMemo:m,useContext:d,useEffect:p}=wp.element;function u(t){let{tasks:a,onChange:n}=t;const[l,i]=c("none"),{filterIncompleteTasks:o,filterCriticalTasks:u,filterMyTasks:k,filterGeneralTasks:g,filterPinnedTasks:f}=d(s),E=m((()=>{const e=o(a);return[{key:"none",title:"All Tasks",tasks:e},{key:"pinned",title:"Pinned",tasks:f(e)},{key:"general",title:"General",tasks:g(e)},{key:"myTasks",title:"My Tasks",tasks:k(window.PTCCompletionist.me.gid,e)},{key:"critical",title:"Critical",tasks:u(e)}]}),[a]);p((()=>{const e=E.find((e=>l===e.key)).tasks;n(l,e)}),[E,l,n]);const C=r(((e,t)=>{i(e),n(e,t)}),[l,i,n]),w=E.map((t=>{let a=`filter-${t.key}`;return l===t.key&&(a+=" --is-active"),(0,e.createElement)("button",{key:t.key,type:"button",className:a,onClick:()=>C(t.key,t.tasks)},`${t.title} (${t.tasks.length})`)}));return(0,e.createElement)("div",{className:"ptc-TaskFilters"},w)}const{useCallback:k,useContext:g}=wp.element;function f(t){let{taskGID:a,processingStatus:n}=t;const{getTaskUrl:l,deleteTask:i,unpinTask:o,removeTask:c,setTaskProcessingStatus:r}=g(s),m=k((e=>{n?console.error(`Rejected handleUnpinTask. Currently ${n} task ${e}.`):(r(e,"unpinning"),o(e).then((t=>{t||r(e,!1)})))}),[n,r,o]),d=k((e=>{n?console.error(`Rejected handleDeleteTask. Currently ${n} task ${e}.`):(r(e,"deleting"),i(e).then((t=>{t||r(e,!1)})))}),[n,r,c]),p=l(a),u="unpinning"===n?"fa-sync-alt fa-spin":"fa-thumbtack",f="deleting"===n?"fa-sync-alt fa-spin":"fa-minus";return(0,e.createElement)("div",{className:"ptc-TaskActions"},(0,e.createElement)("a",{href:p,target:"_asana"},(0,e.createElement)("button",{title:"View in Asana",className:"view",type:"button"},(0,e.createElement)("i",{className:"fas fa-link"}))),(0,e.createElement)("button",{title:"Unpin from Site",className:"unpin",type:"button",onClick:()=>m(a),disabled:!!n},(0,e.createElement)("i",{className:`fas ${u}`})),(0,e.createElement)("button",{title:"Delete from Asana",className:"delete",type:"button",onClick:()=>d(a),disabled:!!n},(0,e.createElement)("i",{className:`fas ${f}`})))}const{useState:E,useCallback:C,useContext:w}=wp.element;function T(t){let{task:a}=t;const[n,l]=E(!1),{isCriticalTask:i,completeTask:o,setTaskProcessingStatus:c}=w(s),r=C((e=>{a.processingStatus?console.error(`Rejected handleMarkComplete. Currently ${a.processingStatus} task ${e}.`):(c(e,"completing"),o(e).then((t=>{c(e,!1)})))}),[a.processingStatus,c,o]),m=C((()=>{a.notes&&l(!n)}),[a,n,l]),d=n?"fas":"far";let p=null;a.assignee&&(p=window.PTCCompletionist.users[a.assignee.gid]?window.PTCCompletionist.users[a.assignee.gid].data.display_name:"(Not Connected)");let u="";i(a)&&(u+=" --is-critical"),!0===a.completed&&(u+=" --is-complete"),a.processingStatus&&(u+=` --is-processing --is-${a.processingStatus}`),a.notes&&(u+=" --has-description");const k="completing"===a.processingStatus?"fa-sync-alt fa-spin":"fa-check",g=new Date(a.due_on).toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric"});return(0,e.createElement)("div",{className:"ptc-TaskRow"+u},(0,e.createElement)("button",{title:"Mark Complete",className:"mark-complete",type:"button",onClick:()=>r(a.gid),disabled:!!a.processingStatus},(0,e.createElement)("i",{className:`fas ${k}`})),(0,e.createElement)("div",{className:"body"},(0,e.createElement)("p",{className:"name",onClick:m},a.name,!!a.notes&&(0,e.createElement)("i",{className:`${d} fa-sticky-note`})),(0,e.createElement)("div",{className:"details"},p&&(0,e.createElement)("p",{className:"assignee"},(0,e.createElement)("i",{class:"fas fa-user"})," ",p),a.due_on&&(0,e.createElement)("p",{className:"due"},(0,e.createElement)("i",{className:"fas fa-clock"})," ",g)),n&&(0,e.createElement)("p",{className:"description"},a.notes)),(0,e.createElement)("div",{className:"actions"},(0,e.createElement)("a",{className:"cta-button",href:a.action_link.href,target:a.action_link.target},a.action_link.label," ",(0,e.createElement)("i",{className:"fas fa-long-arrow-alt-right"})),(0,e.createElement)(f,{taskGID:a.gid,processingStatus:a.processingStatus})))}function h(t){let{tasks:a}=t;const s=a.map((t=>(0,e.createElement)(T,{key:t.gid,task:t})));return(0,e.createElement)("div",{className:"ptc-TaskList"},s)}const{useState:N,useCallback:y,useMemo:b,useContext:v,useEffect:P}=wp.element;function _(t){let{limit:a,tasks:s}=t;const[n,l]=N(1),i=b((()=>Math.ceil(s.length/a)),[s,a]),o=y((e=>{l(e<=1?1:e>=i?i:e)}),[n,l,i]);P((()=>{o(n)}),[s]);const c=Math.max(0,(n-1)*a),r=s.slice(c,n*a),m=[];for(let t=1;t<=i;++t)m.push((0,e.createElement)("button",{className:"num",type:"button",title:`Page ${t}`,disabled:t===n,onClick:()=>o(t)},t));return(0,e.createElement)("div",{className:"ptc-TaskListPaginated"},(0,e.createElement)(h,{tasks:r}),(0,e.createElement)("nav",{className:"pagination"},(0,e.createElement)("button",{className:"prev",type:"button",title:"Previous Page",disabled:1===n,onClick:()=>o(n-1)},(0,e.createElement)("i",{className:"fas fa-angle-left"})),m,(0,e.createElement)("button",{className:"next",type:"button",title:"Next Page",disabled:i===n,onClick:()=>o(n+1)},(0,e.createElement)("i",{className:"fas fa-angle-right"}))),(0,e.createElement)("a",{href:window.PTCCompletionist.tag_url,target:"_asana",className:"view-tag"},(0,e.createElement)("button",{title:"View All Site Tasks in Asana",className:"view",type:"button"},(0,e.createElement)("i",{class:"fas fa-link"}))))}const{useContext:S,useState:$,useEffect:x}=wp.element;function M(){const{tasks:t}=S(s),[a,n]=$(t);return x((()=>n(t)),[t,n]),(0,e.createElement)("div",{className:"ptc-PTCCompletionistTasksDashboardWidget"},(0,e.createElement)(o,{tasks:t}),(0,e.createElement)(u,{tasks:t,onChange:(e,t)=>n(t)}),(0,e.createElement)(_,{limit:5,tasks:a}))}function D(t){let{type:a,message:s,code:n}=t,l=null;"error"===a&&(l="Error",n&&(l+=` ${n}`));let i=null;l&&(i=(0,e.createElement)("strong",null,l+". "));let o="";return a&&(o+=` --has-type-${a}`),(0,e.createElement)("div",{className:"ptc-NoteBox"+o},(0,e.createElement)("p",null,i,s))}const{render:j}=wp.element;document.addEventListener("DOMContentLoaded",(()=>{const t=document.getElementById("ptc-PTCCompletionistTasksDashboardWidget");null!==t&&("error"in window.PTCCompletionist?j((0,e.createElement)(D,{type:"error",message:window.PTCCompletionist.error.message,code:window.PTCCompletionist.error.code}),t):j((0,e.createElement)(n,null,(0,e.createElement)(M,null)),t))}))}();
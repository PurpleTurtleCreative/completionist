(()=>{"use strict";const e=window.wp.element,t=window.wp.plugins,a=window.wp.editPost,{createContext:n,useState:s,useEffect:o}=wp.element,l=n(!1);function c(t){let{children:a}=t;const[n,c]=s(window.PTCCompletionist.tasks);o((()=>()=>{window.PTCCompletionist.tasks=n}),[n]);const i={tasks:n,setTaskProcessingStatus:(e,t)=>{c((a=>a.map((a=>a.gid==e?{...a,processingStatus:t}:{...a}))))},completeTask:async function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const a=i.tasks.find((t=>e===t.gid));let n={action:"ptc_update_task",nonce:window.PTCCompletionist.api.nonce,task_gid:e,completed:t};const s={method:"POST",credentials:"same-origin",body:new URLSearchParams(n)};return await window.fetch(window.ajaxurl,s).then((e=>e.json())).then((e=>(console.log(e),"success"==e.status&&e.data?(i.updateTask({gid:a.gid,completed:t}),!0):("error"==e.status&&e.data?console.error(e.data):alert("[Completionist] Error "+e.code+": "+e.message),!1)))).catch((e=>(console.error("Promise catch:",e),alert("[Completionist] Failed to complete task."),!1)))},deleteTask:async e=>{const t=i.tasks.find((t=>e===t.gid));let a={action:"ptc_delete_task",nonce:window.PTCCompletionist.api.nonce,task_gid:e};t.action_link.post_id&&(a.post_id=t.action_link.post_id);const n={method:"POST",credentials:"same-origin",body:new URLSearchParams(a)};return await window.fetch(window.ajaxurl,n).then((e=>e.json())).then((e=>(console.log(e),"success"==e.status&&e.data?(i.removeTask(e.data),!0):("error"==e.status&&e.data?console.error(e.data):alert("[Completionist] Error "+e.code+": "+e.message),!1)))).catch((e=>(console.error("Promise catch:",e),alert("[Completionist] Failed to delete task."),!1)))},unpinTask:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;i.tasks.find((t=>e===t.gid));let a={action:"ptc_unpin_task",nonce:window.PTCCompletionist.api.nonce,task_gid:e};t&&(a.post_id=t);const n={method:"POST",credentials:"same-origin",body:new URLSearchParams(a)};return await window.fetch(window.ajaxurl,n).then((e=>e.json())).then((e=>(console.log(e),"success"==e.status&&e.data?(i.removeTask(e.data),!0):("error"==e.status&&e.data?console.error(e.data):alert("[Completionist] Error "+e.code+": "+e.message),!1)))).catch((e=>(console.error("Promise catch:",e),alert("[Completionist] Failed to unpin task."),!1)))},pinTask:async(e,t)=>{let a={action:"ptc_pin_task",nonce:window.PTCCompletionist.api.nonce_pin,task_link:e,post_id:t};const n={method:"POST",credentials:"same-origin",body:new URLSearchParams(a)};return await window.fetch(window.ajaxurl,n).then((e=>e.json())).then((e=>(console.log(e),"success"==e.status&&e.data?(i.addTask(e.data),!0):("error"==e.status&&e.data?console.error(e.data):alert("[Completionist] Error "+e.code+": "+e.message),!1)))).catch((e=>(console.error("Promise catch:",e),alert("[Completionist] Failed to pin task."),!1)))},createTask:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a={action:"ptc_create_task",nonce:window.PTCCompletionist.api.nonce_create,...e};t&&(a.post_id=t);const n={method:"POST",credentials:"same-origin",body:new URLSearchParams(a)};return await window.fetch(window.ajaxurl,n).then((e=>e.json())).then((e=>(console.log(e),"success"==e.status&&e.data?(i.addTask(e.data),!0):("error"==e.status&&e.data?console.error(e.data):alert("[Completionist] Error "+e.code+": "+e.message),!1)))).catch((e=>(console.error("Promise catch:",e),alert("[Completionist] Failed to pin task."),!1)))},updateTask:e=>{c((t=>t.map((t=>t.gid==e.gid?{...t,...e}:{...t}))))},addTask:e=>{c((t=>[...t,{...e}]))},removeTask:e=>{c((t=>t.map((t=>{if(t.gid!=e)return{...t}})).filter((e=>!!e))))}};return(0,e.createElement)(l.Provider,{value:i},a)}const{useState:i,useContext:r}=wp.element;function m(t){let{postId:a,disabled:n=!1}=t;const[s,o]=i(""),[c,m]=i(!1),{pinTask:d}=r(l),p=c?"fas fa-sync-alt fa-spin":"fas fa-thumbtack";return(0,e.createElement)("form",{className:"ptc-TaskPinToPostForm",onSubmit:e=>{e.preventDefault(),c||(m(!0),d(s,a).then((e=>{e&&o(""),m(!1)})))},disabled:c||n},(0,e.createElement)("input",{type:"url",placeholder:"Paste a task link...",value:s,onChange:e=>o(e.target.value),disabled:c||n,required:!0}),(0,e.createElement)("button",{title:"Pin existing Asana task",type:"submit",disabled:c||n},(0,e.createElement)("i",{className:p})))}function d(){const t=[];for(const a in window.PTCCompletionist.projects)t.push((0,e.createElement)("option",{value:a,key:a},window.PTCCompletionist.projects[a]));return t}function p(){const t=[];for(const a in window.PTCCompletionist.users){const n=window.PTCCompletionist.users[a].data;t.push((0,e.createElement)("option",{value:a,key:a},`${n.display_name} (${n.user_email})`))}return t}const{useContext:u,useState:g,useMemo:k}=wp.element;function w(t){let{postId:a=null}=t;const[n,s]=g(!1),[o,c]=g(""),[i,r]=g(""),[m,w]=g(""),[f,E]=g(""),[h,C]=g(""),{createTask:T}=u(l),b=k(d,[]),v=k(p,[]),P=n?(0,e.createElement)(e.Fragment,null,(0,e.createElement)("i",{className:"fas fa-sync-alt fa-spin","aria-hidden":"true"}),"Creating task..."):(0,e.createElement)(e.Fragment,null,(0,e.createElement)("i",{className:"fas fa-plus","aria-hidden":"true"}),"Add Task");return(0,e.createElement)("form",{className:"ptc-TaskCreationForm",onSubmit:e=>{e.preventDefault(),n||(s(!0),T({name:o,assignee:i,due_on:m,project:f,notes:h},a).then((e=>{e&&(c(""),r(""),w(""),E(""),C("")),s(!1)})))},disabled:n},(0,e.createElement)("input",{id:"ptc-new-task_name",type:"text",placeholder:"Write a task name...",value:o,onChange:e=>c(e.target.value),disabled:n,required:!0}),(0,e.createElement)("div",{className:"form-group"},(0,e.createElement)("label",{for:"ptc-new-task_assignee"},"Assignee"),(0,e.createElement)("select",{id:"ptc-new-task_assignee",value:i,onChange:e=>r(e.target.value),disabled:n},(0,e.createElement)("option",{value:""},"None (Unassigned)"),v)),(0,e.createElement)("div",{className:"form-group"},(0,e.createElement)("label",{for:"ptc-new-task_due_on"},"Due Date"),(0,e.createElement)("input",{id:"ptc-new-task_due_on",type:"date",pattern:"\\d\\d\\d\\d-\\d\\d-\\d\\d",placeholder:"yyyy-mm-dd",value:m,onChange:e=>w(e.target.value),disabled:n})),(0,e.createElement)("div",{className:"form-group"},(0,e.createElement)("label",{for:"ptc-new-task_project"},"Project"),(0,e.createElement)("select",{id:"ptc-new-task_project",value:f,onChange:e=>E(e.target.value),disabled:n},(0,e.createElement)("option",{value:""},"None (Private Task)"),b)),(0,e.createElement)("div",{className:"form-group"},(0,e.createElement)("label",{for:"ptc-new-task_notes"},"Description"),(0,e.createElement)("textarea",{id:"ptc-new-task_notes",value:h,onChange:e=>C(e.target.value),disabled:n})),(0,e.createElement)("button",{type:"submit",disabled:n},P))}const{useState:f}=wp.element;function E(t){let{postId:a}=t;const[n,s]=f(!1),o=n?"fas fa-times":"fas fa-plus";let l="";return n&&(l+=" --is-showing-creation-form"),(0,e.createElement)("div",{className:"ptc-TaskPinToPostBar"+l},(0,e.createElement)("div",{className:"toolbar"},(0,e.createElement)(m,{postId:a,disabled:n}),(0,e.createElement)("button",{className:"creation-form-toggle",type:"button",title:"Create new task",onClick:()=>{s(!n)}},(0,e.createElement)("i",{className:o,"aria-hidden":"true"}))),n&&(0,e.createElement)(w,{postId:a}))}const{useCallback:h,useContext:C}=wp.element;function T(t){let{taskGID:a,processingStatus:n}=t;const{deleteTask:s,unpinTask:o,removeTask:c,setTaskProcessingStatus:i}=C(l),r=h((e=>{n?console.error(`Rejected handleUnpinTask. Currently ${n} task ${e}.`):(i(e,"unpinning"),o(e).then((t=>{t||i(e,!1)})))}),[n,i,o]),m=h((e=>{n?console.error(`Rejected handleDeleteTask. Currently ${n} task ${e}.`):(i(e,"deleting"),s(e).then((t=>{t||i(e,!1)})))}),[n,i,c]),d=function(e){return`https://app.asana.com/0/0/${e}/f`}(a),p="unpinning"===n?"fa-sync-alt fa-spin":"fa-thumbtack",u="deleting"===n?"fa-sync-alt fa-spin":"fa-minus";return(0,e.createElement)("div",{className:"ptc-TaskActions"},(0,e.createElement)("a",{href:d,target:"_asana"},(0,e.createElement)("button",{title:"View in Asana",className:"view",type:"button"},(0,e.createElement)("i",{className:"fas fa-link"}))),(0,e.createElement)("button",{title:"Unpin from Site",className:"unpin",type:"button",onClick:()=>r(a),disabled:!!n},(0,e.createElement)("i",{className:`fas ${p}`})),(0,e.createElement)("button",{title:"Delete from Asana",className:"delete",type:"button",onClick:()=>m(a),disabled:!!n},(0,e.createElement)("i",{className:`fas ${u}`})))}const{useState:b,useCallback:v,useContext:P}=wp.element;function _(t){let{task:a}=t;const[n,s]=b(!1),{completeTask:o,setTaskProcessingStatus:c}=P(l),i=v((e=>{a.processingStatus?console.error(`Rejected handleMarkComplete. Currently ${a.processingStatus} task ${e}.`):(c(e,"completing"),o(e,!a.completed).then((t=>{c(e,!1)})))}),[a.processingStatus,c,o]),r=v((()=>{a.notes&&s(!n)}),[a,n,s]),m=n?"fas":"far";let d=function(e){let t=null;return e.assignee&&(t=window.PTCCompletionist.users[e.assignee.gid]?window.PTCCompletionist.users[e.assignee.gid].data.display_name:"(Not Connected)"),t}(a),p="";(function(e){return Date.parse(e.due_on)-Date.now()<604800})(a)&&(p+=" --is-critical"),!0===a.completed&&(p+=" --is-complete"),a.processingStatus&&(p+=` --is-processing --is-${a.processingStatus}`),a.notes&&(p+=" --has-description");const u="completing"===a.processingStatus?"fa-sync-alt fa-spin":"fa-check",g=new Date(a.due_on).toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric",timeZone:"UTC"});return(0,e.createElement)("div",{className:"ptc-TaskRow"+p},(0,e.createElement)("button",{title:"Mark Complete",className:"mark-complete",type:"button",onClick:()=>i(a.gid),disabled:!!a.processingStatus},(0,e.createElement)("i",{className:`fas ${u}`})),(0,e.createElement)("div",{className:"body"},(0,e.createElement)("p",{className:"name",onClick:r},a.name,!!a.notes&&(0,e.createElement)("i",{className:`${m} fa-sticky-note`})),(0,e.createElement)("div",{className:"details"},d&&(0,e.createElement)("p",{className:"assignee"},(0,e.createElement)("i",{class:"fas fa-user"})," ",d),a.due_on&&(0,e.createElement)("p",{className:"due"},(0,e.createElement)("i",{className:"fas fa-clock"})," ",g)),n&&(0,e.createElement)("p",{className:"description"},a.notes)),(0,e.createElement)("div",{className:"actions"},(0,e.createElement)("a",{className:"cta-button",href:a.action_link.href,target:a.action_link.target},a.action_link.label," ",(0,e.createElement)("i",{className:"fas fa-long-arrow-alt-right"})),(0,e.createElement)(T,{taskGID:a.gid,processingStatus:a.processingStatus})))}function y(t){let{tasks:a}=t,n=(0,e.createElement)("p",{className:"ptc-no-results"},(0,e.createElement)("i",{className:"fas fa-clipboard-check"}),"No tasks to display.");return a.length>0&&(n=a.map((t=>(0,e.createElement)(_,{key:t.gid,task:t})))),(0,e.createElement)("div",{className:"ptc-TaskList"},n)}const{useContext:N}=wp.element;function S(){const{tasks:t}=N(l),a=wp.data.select("core/editor").getCurrentPostId();return(0,e.createElement)("div",{className:"ptc-BlockEditorPanelTasks"},(0,e.createElement)(E,{postId:a}),(0,e.createElement)(y,{tasks:t}))}function j(t){let{type:a,message:n,code:s}=t,o=null;"error"===a&&(o="Error",s&&(o+=` ${s}`));let l=null;o&&(l=(0,e.createElement)("strong",null,o+". "));let c="";return a&&(c+=` --has-type-${a}`),(0,e.createElement)("div",{className:"ptc-NoteBox"+c},(0,e.createElement)("p",null,l,n))}(0,t.registerPlugin)("ptc-completionist",{render:()=>{window.console.log("!! ptc-completionist plugin ReactJS !!");let t=null;return t="error"in window.PTCCompletionist?(0,e.createElement)(j,{type:"error",message:window.PTCCompletionist.error.message,code:window.PTCCompletionist.error.code}):(0,e.createElement)(c,null,(0,e.createElement)(S,null)),(0,e.createElement)(a.PluginDocumentSettingPanel,{name:"ptc-completionist-tasks",title:"Completionist",className:"ptc-completionist-tasks"},t)},icon:(0,e.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 384 512"},(0,e.createElement)("path",{d:"M336 64h-53.88C268.9 26.8 233.7 0 192 0S115.1 26.8 101.9 64H48C21.5 64 0 85.48 0 112v352C0 490.5 21.5 512 48 512h288c26.5 0 48-21.48 48-48v-352C384 85.48 362.5 64 336 64zM192 64c17.67 0 32 14.33 32 32s-14.33 32-32 32S160 113.7 160 96S174.3 64 192 64zM282.9 262.8l-88 112c-4.047 5.156-10.02 8.438-16.53 9.062C177.6 383.1 176.8 384 176 384c-5.703 0-11.25-2.031-15.62-5.781l-56-48c-10.06-8.625-11.22-23.78-2.594-33.84c8.609-10.06 23.77-11.22 33.84-2.594l36.98 31.69l72.52-92.28c8.188-10.44 23.3-12.22 33.7-4.062C289.3 237.3 291.1 252.4 282.9 262.8z"}))})})();
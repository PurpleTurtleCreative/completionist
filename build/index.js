!function(){"use strict";var t=window.wp.element;const{Component:e}=wp.element;class a extends e{constructor(t){super(t),this.state={...t.automation,isDeleting:!1},this.goToAutomation=t.goToAutomation,this.deleteAutomation=this.deleteAutomation.bind(this)}deleteAutomation(){this.setState({isDeleting:!0},(()=>{this.props.deleteAutomation(this.state.ID,(()=>{this.setState({isDeleting:!1})}))}))}render(){return(0,t.createElement)("div",{className:"ptc-completionist-automation-row"},(0,t.createElement)("header",null,(0,t.createElement)("h2",{title:"Automation ID: "+this.state.ID,onClick:()=>this.goToAutomation(this.state.ID)},this.state.title),(0,t.createElement)("p",{className:"last-modified"},(0,t.createElement)("em",null,"Updated ",this.state.last_modified)),this.state.description.length>0&&(0,t.createElement)("p",{className:"description",dangerouslySetInnerHTML:{__html:this.state.description}}),(0,t.createElement)("div",{className:"automation-actions"},(0,t.createElement)("button",{className:"edit",onClick:()=>this.goToAutomation(this.state.ID)},(0,t.createElement)("i",{className:"fas fa-pen"})," Edit"),(0,t.createElement)("button",{className:"delete",onClick:this.deleteAutomation,disabled:this.state.isDeleting},(0,t.createElement)("i",{className:"fas fa-trash"})," Delete"))),(0,t.createElement)("ul",null,(0,t.createElement)("li",{title:this.state.total_conditions+" Conditions"},this.state.total_conditions),(0,t.createElement)("li",{title:this.state.total_actions+" Actions"},this.state.total_actions),(0,t.createElement)("li",{title:"Triggered "+this.state.total_triggered+" times"},this.state.total_triggered),(0,t.createElement)("li",{title:"Last Triggered "+this.state.last_triggered},this.state.last_triggered)))}}const{Component:n}=wp.element;class s extends n{constructor(t){super(t),this.state={automations:t.automations,orderBy:"title"},this.goToAutomation=t.goToAutomation}sortAutomationsListing(){}componentDidUpdate(t){this.props.automations!==t.automations&&this.setState({automations:this.props.automations})}render(){const e=this.state.automations.map((e=>(0,t.createElement)(a,{key:e.ID,automation:e,goToAutomation:this.goToAutomation,deleteAutomation:this.props.deleteAutomation})));return(0,t.createElement)("div",{className:"ptc-completionist-automations-listing"},(0,t.createElement)("div",{className:"title"},(0,t.createElement)("h1",null,"Automations"),(0,t.createElement)("div",{className:"actions"},(0,t.createElement)("button",{onClick:()=>this.goToAutomation("new")},(0,t.createElement)("i",{className:"fas fa-plus"})," Add New"))),(0,t.createElement)("header",null,(0,t.createElement)("div",null,"Automation"),(0,t.createElement)("div",null,(0,t.createElement)("i",{className:"fas fa-question"})," Conditions"),(0,t.createElement)("div",null,(0,t.createElement)("i",{className:"fas fa-running"})," Actions"),(0,t.createElement)("div",null,(0,t.createElement)("i",{className:"fas fa-bolt"})," Triggers"),(0,t.createElement)("div",null,(0,t.createElement)("i",{className:"fas fa-history"})," Last Triggered")),(0,t.createElement)("div",{className:"ptc-completionist-automations-list"},e))}}const{Component:o}=wp.element;class i extends o{constructor(t){super(t),this.state={isLoading:!1,currentRequest:{},textInputHasFocus:!1,options:[],currentValue:"",currentLabel:""},"initialValue"in t&&t.initialValue&&(this.state.currentValue=t.initialValue),"initialLabel"in t&&t.initialLabel&&(this.state.currentLabel=t.initialLabel),this.handleSearchChange=this.handleSearchChange.bind(this),this.handleOptionChange=this.handleOptionChange.bind(this),this.createSelectOptions=this.createSelectOptions.bind(this),this.handleSearchBlur=this.handleSearchBlur.bind(this)}handleSearchChange(t){t.trim().length>=3?this.setState({isLoading:!0,currentValue:"",currentLabel:t,options:[]},(()=>{let t={action:"ptc_get_post_options_by_title",nonce:window.ptc_completionist_automations.nonce,title:this.state.currentLabel},e=window.jQuery.post(window.ajaxurl,t,(t=>{this.setState({isLoading:!1,currentRequest:{},options:t.data})}),"json").fail(((t,e)=>{"abort"!=e&&(alert("Failed to search for posts by title."),this.setState({isLoading:!1,options:[]}))}));this.setState((t=>("object"==typeof t.currentRequest&&"function"==typeof t.currentRequest.abort&&this.state.currentRequest.abort(),{currentRequest:e})))})):this.setState({isLoading:!1,currentValue:"",currentLabel:t,options:[]})}handleOptionChange(t,e){this.setState((a=>({currentValue:t,currentLabel:e})),(()=>{this.props.onSelectOption(this.state.currentValue)}))}handleSearchBlur(){this.setState((t=>({textInputHasFocus:!1,currentLabel:""===t.currentValue?"":t.currentLabel})))}createSelectOptions(){return this.state.options.length<1?!0===this.state.isLoading?(0,t.createElement)("li",null,(0,t.createElement)("i",{className:"fas fa-spinner fa-pulse"})," Searching for posts..."):this.state.currentLabel.trim().length>=3?(0,t.createElement)("li",null,"No post results."):(0,t.createElement)("li",null,"Enter at least 3 characters to search..."):this.state.options.map((e=>(0,t.createElement)("li",{className:"post-option","data-value":e.ID,key:e.ID,onMouseDown:()=>this.handleOptionChange(e.ID,e.post_title)},e.post_title+" ["+e.ID+"]")))}componentDidMount(){""!==this.state.currentValue.trim()&&""===this.state.currentLabel.trim()&&this.setState({currentLabel:"(Loading...)"},(()=>{let t={action:"ptc_get_post_title_by_id",nonce:window.ptc_completionist_automations.nonce,post_id:this.state.currentValue};window.jQuery.post(window.ajaxurl,t,(t=>{"success"==t.status&&""!=t.data?this.setState({currentLabel:t.data}):(console.error("Failed to load initial PostSearchSelectInput label for initial value."),console.error(t),this.setState({currentLabel:"(Error: Failed to load post title)"}))}),"json").fail((()=>{console.error("Failed to load initial PostSearchSelectInput label for initial value."),this.setState({currentLabel:"(Error: Failed to load post title)"})}))}))}componentDidUpdate(t,e){this.state.currentValue!==e.currentValue&&this.props.onSelectOption(this.state.currentValue)}render(){let e=null;if(!0===this.state.textInputHasFocus){const a=this.createSelectOptions(this.state.options);e=(0,t.createElement)("ul",{className:"select-options"},a)}return(0,t.createElement)("div",{className:"ptc-ajax-search-select-input"},(0,t.createElement)("input",{id:this.props.id,type:"text",value:this.state.currentLabel,onChange:t=>this.handleSearchChange(t.target.value),onFocus:()=>this.setState({textInputHasFocus:!0}),onBlur:()=>this.handleSearchBlur()}),(0,t.createElement)("input",{type:"hidden",value:this.state.currentValue}),e)}}const{Component:l}=wp.element;class c extends l{constructor(t){super(t),"automation"in t?(this.state=t.automation,this.state.saveButtonLabel="Create","ID"in t.automation&&t.automation.ID>0&&(this.state.saveButtonLabel="Update"),this.state.isSubmitting=!1):this.state={ID:0,title:"",description:"",hook_name:"",last_modified:"",conditions:[],actions:[],saveButtonLabel:"Create",isSubmitting:!1},this.handleAutomationChange=this.handleAutomationChange.bind(this),this.handleConditionChange=this.handleConditionChange.bind(this),this.handleAddCondition=this.handleAddCondition.bind(this),this.handleRemoveCondition=this.handleRemoveCondition.bind(this),this.handleActionChange=this.handleActionChange.bind(this),this.handleActionMetaChange=this.handleActionMetaChange.bind(this),this.handleAddAction=this.handleAddAction.bind(this),this.handleRemoveAction=this.handleRemoveAction.bind(this)}saveAutomation(){this.state.isSubmitting||this.setState({isSubmitting:!0},(()=>{let t={action:"ptc_save_automation",nonce:window.ptc_completionist_automations.nonce,automation:this.state};window.jQuery.post(window.ajaxurl,t,(t=>{t.status&&"success"==t.status&&t.code&&t.data&&"object"==typeof t.data&&"ID"in t.data&&t.data.ID&&t.data.ID>0?201==t.code?this.props.goToAutomation(t.data.ID):200==t.code&&this.setState({...t.data,isSubmitting:!1}):(t.message&&t.code?alert("Error "+t.code+". The automation could not be saved. "+t.message):alert("Error 409. The automation could not be saved."),this.setState({isSubmitting:!1}))}),"json").fail((()=>{alert("Error 500. The automation could not be saved."),this.setState({isSubmitting:!1})}))}))}handleAutomationChange(t,e){this.setState((a=>({[t]:e})))}handleConditionChange(t,e,a){this.setState((n=>{let s=[...n.conditions];return s[t]={...n.conditions[t],[e]:a},{conditions:s}}))}handleAddCondition(){this.setState((t=>({conditions:[...t.conditions,{ID:0,property:"",comparison_method:window.ptc_completionist_automations.field_comparison_methods[0],value:""}]})))}handleRemoveCondition(t){this.setState((e=>({conditions:e.conditions.filter(((e,a)=>a!==t))})))}handleActionChange(t,e){this.setState((a=>{let n=[...a.actions];return n[t]={...a.actions[t],action:e,meta:this.getDefaultActionMeta(e)},{actions:n}}))}handleActionMetaChange(t,e,a){this.setState((n=>{let s=[...n.actions];return s[t]={...n.actions[t],meta:{...n.actions[t].meta,[e]:a}},{actions:s}}))}handleAddAction(){this.setState((t=>({actions:[...t.actions,{ID:0,action:"create_task",triggered_count:0,last_triggered:"",meta:this.getDefaultActionMeta("create_task")}]})))}handleRemoveAction(t){this.setState((e=>({actions:e.actions.filter(((e,a)=>a!==t))})))}getDefaultActionMeta(t){return"create_task"===t?{task_author:Object.keys(window.ptc_completionist_automations.connected_workspace_users)[0]}:{}}render(){return(0,t.createElement)("div",{className:"ptc-completionist-automation-details-form"},(0,t.createElement)(r,{title:this.state.title,changeTitle:t=>this.handleAutomationChange("title",t),description:this.state.description,changeDescription:t=>this.handleAutomationChange("description",t)}),(0,t.createElement)(m,{hook_name:this.state.hook_name,changeEvent:t=>this.handleAutomationChange("hook_name",t)}),(0,t.createElement)(d,{event:this.state.hook_name,conditions:this.state.conditions,changeCondition:this.handleConditionChange,addCondition:this.handleAddCondition,removeCondition:this.handleRemoveCondition}),(0,t.createElement)(u,{event:this.state.hook_name,actions:this.state.actions,changeAction:this.handleActionChange,addAction:this.handleAddAction,removeAction:this.handleRemoveAction,changeActionMeta:this.handleActionMetaChange}),this.state.isSubmitting?(0,t.createElement)("button",{className:"save-automation",onClick:()=>this.saveAutomation(),disabled:"disabled"},(0,t.createElement)("i",{className:"fas fa-spinner fa-pulse"})," Saving..."):(0,t.createElement)("button",{className:"save-automation",onClick:()=>this.saveAutomation()},(0,t.createElement)("i",{className:"fas fa-save"})," ",this.state.saveButtonLabel))}}class r extends l{constructor(t){super(t)}render(){return(0,t.createElement)("div",{className:"automation-info"},(0,t.createElement)("div",{className:"form-group"},(0,t.createElement)("label",{for:"automation-title"},"Title"),(0,t.createElement)("input",{id:"automation-title",type:"text",value:this.props.title,onChange:t=>this.props.changeTitle(t.target.value)})),(0,t.createElement)("div",{className:"form-group"},(0,t.createElement)("label",{for:"automation-description"},"Description"),(0,t.createElement)("textarea",{id:"automation-description",value:this.props.description,onChange:t=>this.props.changeDescription(t.target.value)})))}}class m extends l{constructor(t){super(t)}createSelectOptions(e){return Object.keys(e).map((a=>(0,t.createElement)("option",{value:a,key:a},e[a])))}render(){const e=this.createSelectOptions(window.ptc_completionist_automations.event_user_options),a=this.createSelectOptions(window.ptc_completionist_automations.event_post_options);return(0,t.createElement)("div",{className:"automation-event"},(0,t.createElement)("h2",null,(0,t.createElement)("span",{className:"automation-step-number"},"1")," Trigger Event"),(0,t.createElement)("select",{value:this.props.hook_name,onChange:t=>this.props.changeEvent(t.target.value)},(0,t.createElement)("option",{value:""},"(Choose Event)"),(0,t.createElement)("optgroup",{label:"User Events"},e),(0,t.createElement)("optgroup",{label:"Post Events"},a)))}}class d extends l{constructor(t){super(t),this.loadPropertyOptions=this.loadPropertyOptions.bind(this),this.loadComparisonMethodOptions=this.loadComparisonMethodOptions.bind(this),this.loadConditionFieldsets=this.loadConditionFieldsets.bind(this)}createSelectOptions(e){return Object.keys(e).map((a=>(0,t.createElement)("option",{value:a,key:a},e[a])))}loadPropertyOptions(){Object.keys(window.ptc_completionist_automations.event_user_options).includes(this.props.event)?this.propertyOptions=this.createSelectOptions(window.ptc_completionist_automations.field_user_options):Object.keys(window.ptc_completionist_automations.event_post_options).includes(this.props.event)?this.propertyOptions=this.createSelectOptions(window.ptc_completionist_automations.field_post_options):this.propertyOptions=(0,t.createElement)("option",null,"(Choose Event)")}loadComparisonMethodOptions(){this.comparisonMethodOptions=window.ptc_completionist_automations.field_comparison_methods.map((e=>(0,t.createElement)("option",{value:e,key:e},e)))}loadConditionFieldsets(){this.conditionFieldsets=this.props.conditions.map(((e,a)=>{let n=null;return"is empty"!==e.comparison_method&&"is filled"!==e.comparison_method&&(n=(0,t.createElement)("input",{type:"text",value:e.value,key:a,onChange:t=>this.props.changeCondition(a,"value",t.target.value)})),(0,t.createElement)("fieldset",{className:"automation-condition",key:a},(0,t.createElement)("legend",null,"Condition"),(0,t.createElement)("div",{className:"form-group"},(0,t.createElement)("select",{value:e.property,key:a,onChange:t=>this.props.changeCondition(a,"property",t.target.value)},this.propertyOptions),(0,t.createElement)("select",{value:e.comparison_method,key:a,onChange:t=>this.props.changeCondition(a,"comparison_method",t.target.value)},this.comparisonMethodOptions),n,(0,t.createElement)("button",{className:"remove-item",title:"Remove Condition",onClick:()=>this.props.removeCondition(a)},(0,t.createElement)("i",{className:"fas fa-minus"})," Delete")))}))}render(){return this.loadPropertyOptions(),this.loadComparisonMethodOptions(),this.loadConditionFieldsets(),(0,t.createElement)("div",{className:"automation-conditions-list"},(0,t.createElement)("h2",null,(0,t.createElement)("span",{className:"automation-step-number"},"2")," Conditions"),this.conditionFieldsets,(0,t.createElement)("button",{className:"add-item",onClick:this.props.addCondition},(0,t.createElement)("i",{className:"fas fa-plus"})," Add Condition"))}}class u extends l{constructor(t){super(t),this.loadActionMetaInputs=this.loadActionMetaInputs.bind(this),this.loadActionFieldsets=this.loadActionFieldsets.bind(this)}createSelectOptions(e){return Object.keys(e).map((a=>(0,t.createElement)("option",{value:a,key:a},e[a])))}loadActionMetaInputs(e,a){return"create_task"===e.action?(0,t.createElement)("div",{className:"action-meta_create_task"},(0,t.createElement)("input",{id:"ptc-new-task_name_"+a,type:"text",placeholder:"Write a task name...",value:e.meta.name,onChange:t=>this.props.changeActionMeta(a,"name",t.target.value)}),(0,t.createElement)("div",{className:"form-group"},(0,t.createElement)("label",{for:"ptc-new-task_task_author_"+a},"Creator"),(0,t.createElement)("select",{id:"ptc-new-task_task_author_"+a,value:e.meta.task_author,onChange:t=>this.props.changeActionMeta(a,"task_author",t.target.value)},this.createSelectOptions(window.ptc_completionist_automations.connected_workspace_users))),(0,t.createElement)("div",{className:"form-group"},(0,t.createElement)("label",{for:"ptc-new-task_assignee_"+a},"Assignee"),(0,t.createElement)("select",{id:"ptc-new-task_assignee_"+a,value:e.meta.assignee,onChange:t=>this.props.changeActionMeta(a,"assignee",t.target.value)},(0,t.createElement)("option",{value:""},"None (Unassigned)"),this.createSelectOptions(window.ptc_completionist_automations.workspace_users))),(0,t.createElement)("div",{className:"form-group"},(0,t.createElement)("label",{for:"ptc-new-task_due_on_"+a},"Due Date"),(0,t.createElement)("input",{id:"ptc-new-task_due_on_"+a,type:"date",pattern:"\\d\\d\\d\\d-\\d\\d-\\d\\d",placeholder:"yyyy-mm-dd",value:e.meta.due_on,onChange:t=>this.props.changeActionMeta(a,"due_on",t.target.value)})),(0,t.createElement)("div",{className:"form-group"},(0,t.createElement)("label",{for:"ptc-new-task_project_"+a},"Project"),(0,t.createElement)("select",{id:"ptc-new-task_project_"+a,value:e.meta.project,onChange:t=>this.props.changeActionMeta(a,"project",t.target.value)},(0,t.createElement)("option",{value:""},"None (Private Task)"),this.createSelectOptions(window.ptc_completionist_automations.workspace_projects))),(0,t.createElement)("div",{className:"form-group"},(0,t.createElement)("label",{for:"ptc-new-task_notes_"+a},"Description"),(0,t.createElement)("textarea",{id:"ptc-new-task_notes_"+a,value:e.meta.notes,onChange:t=>this.props.changeActionMeta(a,"notes",t.target.value)})),(0,t.createElement)("div",{className:"form-group"},(0,t.createElement)("label",{for:"ptc-new-task_post_id_"+a},"Pin to Post"),(0,t.createElement)(i,{id:"ptc-new-task_post_id_"+a,initialValue:e.meta.post_id,onSelectOption:t=>this.props.changeActionMeta(a,"post_id",t)}))):(0,t.createElement)("div",{className:"automation-meta-default"},(0,t.createElement)("p",null,(0,t.createElement)("em",null,"Choose an action to see additional options.")))}loadActionFieldsets(){let e=this.createSelectOptions(window.ptc_completionist_automations.action_options);this.actionFieldsets=this.props.actions.map(((a,n)=>(0,t.createElement)("fieldset",{className:"automation-action",key:n},(0,t.createElement)("legend",null,"Action"),(0,t.createElement)("div",{className:"form-group"},(0,t.createElement)("select",{value:a.action,onChange:t=>this.props.changeAction(n,t.target.value),key:n},e),(0,t.createElement)("div",null,(0,t.createElement)("button",{className:"remove-item",title:"Remove Action",onClick:()=>this.props.removeAction(n)},(0,t.createElement)("i",{className:"fas fa-minus"})," Delete"))),this.loadActionMetaInputs(a,n))))}render(){return this.loadActionFieldsets(),(0,t.createElement)("div",{className:"automation-actions-list"},(0,t.createElement)("h2",null,(0,t.createElement)("span",{className:"automation-step-number"},"3")," Actions"),this.actionFieldsets,(0,t.createElement)("button",{className:"add-item",onClick:this.props.addAction},(0,t.createElement)("i",{className:"fas fa-plus"})," Add Action"))}}const{Component:p}=wp.element;class h extends p{constructor(t){super(t),this.state={automations:window.ptc_completionist_automations.automations,isLoading:!1},this.goToAutomation=this.goToAutomation.bind(this),this.deleteAutomation=this.deleteAutomation.bind(this)}goToAutomation(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.setState({isLoading:!0},(()=>{if("new"===t){let e=new URLSearchParams(location.search);e.set("automation",t),history.pushState({ID:"new"},"Completionist – Add New Automation","?"+e.toString()),document.title="Completionist – Add New Automation",this.setState({isLoading:!1})}else if(isNaN(parseInt(t))||t<=0){let t={action:"ptc_get_automation_overviews",nonce:window.ptc_completionist_automations.nonce};window.jQuery.post(window.ajaxurl,t,(t=>{if("success"==t.status&&"object"==typeof t.data){let e=new URLSearchParams(location.search);e.delete("automation"),history.pushState({ID:0},"Completionist – Automations","?"+e.toString()),document.title="Completionist – Automations",this.setState({automations:t.data,isLoading:!1})}else console.error(t),this.setState({isLoading:!1})}),"json").fail((()=>{console.error("Failed to load automation overviews.");let t=new URLSearchParams(location.search);t.delete("automation"),history.pushState({ID:0},"Completionist – Automations","?"+t.toString()),document.title="Completionist – Automations",this.setState({isLoading:!1})}))}else{let e={action:"ptc_get_automation",nonce:window.ptc_completionist_automations.nonce,ID:t};window.jQuery.post(window.ajaxurl,e,(e=>{if("success"==e.status&&"object"==typeof e.data){let a="Completionist – Automation "+e.data.ID+" – "+e.data.title,n=new URLSearchParams(location.search);n.set("automation",t),history.pushState(e.data,a,"?"+n.toString()),document.title=a,this.setState({isLoading:!1})}else console.error(e),this.goToAutomation()}),"json").fail((()=>{console.error("Failed to get data for automation "+t),this.goToAutomation()}))}}))}deleteAutomation(t,e){let a={action:"ptc_delete_automation",nonce:window.ptc_completionist_automations.nonce,ID:t};window.jQuery.post(window.ajaxurl,a,(t=>{t.status&&"success"==t.status&&t.code&&200==t.code&&t.data?(console.log(t.message),this.setState((e=>({automations:e.automations.filter((e=>e.ID!==t.data))})))):t.message&&t.code?alert("Error "+t.code+". The automation could not be deleted. "+t.message):alert("Error. The automation could not be deleted."),"function"==typeof e&&e(t)}),"json").fail((()=>{alert("Error 500. The automation could not be deleted."),"function"==typeof e&&e()}))}componentDidMount(){const t=new URLSearchParams(location.search).get("automation");null!==t&&this.goToAutomation(t),window.addEventListener("popstate",(t=>{"state"in t&&t.state&&"ID"in t.state?this.goToAutomation(t.state.ID):this.goToAutomation()}))}render(){if(this.state.isLoading)return(0,t.createElement)("div",{className:"loading-screen"},(0,t.createElement)("p",null,(0,t.createElement)("i",{className:"fas fa-spinner fa-pulse fa-lg"})," Loading..."));const e=new URLSearchParams(location.search).get("automation");return"new"===e?(0,t.createElement)("div",{className:"ptc-completionist-automation-create"},(0,t.createElement)("header",null,(0,t.createElement)("button",{onClick:()=>this.goToAutomation()},(0,t.createElement)("i",{className:"fas fa-angle-left"})," Back"),(0,t.createElement)("h1",null,"New Automation"),(0,t.createElement)("div",{className:"spacer"})),(0,t.createElement)(c,{goToAutomation:this.goToAutomation})):history.state&&"ID"in history.state&&history.state.ID==e?(0,t.createElement)("div",{className:"ptc-completionist-automation-details"},(0,t.createElement)("header",null,(0,t.createElement)("button",{onClick:()=>this.goToAutomation()},(0,t.createElement)("i",{className:"fas fa-angle-left"})," Back"),(0,t.createElement)("h1",null,"Edit Automation ",history.state.ID),(0,t.createElement)("div",{className:"spacer"})),(0,t.createElement)(c,{automation:history.state,goToAutomation:this.goToAutomation})):(0,t.createElement)(s,{automations:this.state.automations,goToAutomation:this.goToAutomation,deleteAutomation:this.deleteAutomation})}}const{createContext:g,useState:E}=wp.element,k=g(!1);function f(e){let{children:a}=e;const[n,s]=E(Object.values(window.PTCCompletionist.tasks)),o={tasks:n,setTaskProcessingStatus:(t,e)=>{s((a=>a.map((a=>a.gid==t?{...a,processingStatus:e}:{...a}))))},completeTask:async function(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const a=o.tasks.find((e=>t===e.gid));let n={action:"ptc_update_task",nonce:window.PTCCompletionist.api.nonce,task_gid:t,completed:e};const s={method:"POST",credentials:"same-origin",body:new URLSearchParams(n)};return await window.fetch(window.ajaxurl,s).then((t=>t.json())).then((t=>(console.log(t),"success"==t.status&&t.data?(o.updateTask({gid:a.gid,completed:e}),!0):("error"==t.status&&t.data?console.error(t.data):alert("[Completionist] Error "+t.code+": "+t.message),!1)))).catch((t=>(console.error("Promise catch:",t),alert("[Completionist] Failed to complete task."),!1)))},deleteTask:async t=>{const e=o.tasks.find((e=>t===e.gid));let a={action:"ptc_delete_task",nonce:window.PTCCompletionist.api.nonce,task_gid:t};e.action_link.post_id&&(a.post_id=e.action_link.post_id);const n={method:"POST",credentials:"same-origin",body:new URLSearchParams(a)};return await window.fetch(window.ajaxurl,n).then((t=>t.json())).then((t=>(console.log(t),"success"==t.status&&t.data?(o.removeTask(t.data),!0):("error"==t.status&&t.data?console.error(t.data):alert("[Completionist] Error "+t.code+": "+t.message),!1)))).catch((t=>(console.error("Promise catch:",t),alert("[Completionist] Failed to delete task."),!1)))},unpinTask:async function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;o.tasks.find((e=>t===e.gid));let a={action:"ptc_unpin_task",nonce:window.PTCCompletionist.api.nonce,task_gid:t};e&&(a.post_id=e);const n={method:"POST",credentials:"same-origin",body:new URLSearchParams(a)};return await window.fetch(window.ajaxurl,n).then((t=>t.json())).then((t=>(console.log(t),"success"==t.status&&t.data?(o.removeTask(t.data),!0):("error"==t.status&&t.data?console.error(t.data):alert("[Completionist] Error "+t.code+": "+t.message),!1)))).catch((t=>(console.error("Promise catch:",t),alert("[Completionist] Failed to unpin task."),!1)))},updateTask:t=>{s((e=>e.map((e=>e.gid==t.gid?{...e,...t}:{...e}))))},removeTask:t=>{s((e=>e.map((e=>{if(e.gid!=t)return{...e}})).filter((t=>!!t))))},getTaskUrl:t=>`https://app.asana.com/0/0/${t}/f`,isCriticalTask:t=>Date.parse(t.due_on)-Date.now()<604800,filterIncompleteTasks:t=>t.filter((t=>!t.completed)),filterCriticalTasks:t=>t.filter((t=>o.isCriticalTask(t))),filterMyTasks:(t,e)=>e.filter((e=>!!e.assignee&&t===e.assignee.gid)),filterGeneralTasks:t=>t.filter((t=>!(t.action_link&&t.action_link.post_id>0))),filterPinnedTasks:t=>t.filter((t=>!!(t.action_link&&t.action_link.post_id>0)))};return(0,t.createElement)(k.Provider,{value:o},a)}const{useContext:_,useMemo:v}=wp.element;function C(){const{tasks:e,filterIncompleteTasks:a}=_(k),n=v((()=>a(e)),[e]),s=e.length-n.length;let o=0;return e.length>0&&(o=Math.round(s/e.length*100)),(0,t.createElement)("div",{className:"ptc-TaskOverview"},(0,t.createElement)("div",{className:"feature"},(0,t.createElement)("p",{className:"large"},o,(0,t.createElement)("span",{className:"small"},"%")),(0,t.createElement)("p",{className:"caption"},"Complete")),(0,t.createElement)("div",{className:"details"},(0,t.createElement)("p",{className:"incomplete"},(0,t.createElement)("span",{className:"count"},n.length)," Remaining"),(0,t.createElement)("div",{className:"progress"},(0,t.createElement)("div",{className:"progress-bar-wrapper"},(0,t.createElement)("div",{className:"progress-bar",style:{width:`${o}%`}})),(0,t.createElement)("p",{className:"caption"},(0,t.createElement)("span",{className:"completed"},"Completed ",s)," of ",e.length))))}const{useState:w,useCallback:b,useMemo:A,useContext:N,useEffect:S}=wp.element;function y(e){let{tasks:a,onChange:n}=e;const[s,o]=w("none"),{filterIncompleteTasks:i,filterCriticalTasks:l,filterMyTasks:c,filterGeneralTasks:r,filterPinnedTasks:m}=N(k),d=A((()=>{const t=i(a);return[{key:"none",title:"All Tasks",tasks:t},{key:"pinned",title:"Pinned",tasks:m(t)},{key:"general",title:"General",tasks:r(t)},{key:"myTasks",title:"My Tasks",tasks:c(window.PTCCompletionist.me.gid,t)},{key:"critical",title:"Critical",tasks:l(t)}]}),[a]);S((()=>{const t=d.find((t=>s===t.key)).tasks;n(s,t)}),[d,s,n]);const u=b(((t,e)=>{o(t),n(t,e)}),[s,o,n]),p=d.map((e=>{let a=`filter-${e.key}`;return s===e.key&&(a+=" --is-active"),(0,t.createElement)("button",{key:e.key,type:"button",className:a,onClick:()=>u(e.key,e.tasks)},`${e.title} (${e.tasks.length})`)}));return(0,t.createElement)("div",{className:"ptc-TaskFilters"},p)}const{useCallback:T,useContext:D}=wp.element;function L(e){let{taskGID:a,processingStatus:n}=e;const{getTaskUrl:s,deleteTask:o,unpinTask:i,removeTask:l,setTaskProcessingStatus:c}=D(k),r=T((t=>{n?console.error(`Rejected handleUnpinTask. Currently ${n} task ${t}.`):(c(t,"unpinning"),i(t).then((e=>{e||c(t,!1)})))}),[n,c,i]),m=T((t=>{n?console.error(`Rejected handleDeleteTask. Currently ${n} task ${t}.`):(c(t,"deleting"),o(t).then((e=>{e||c(t,!1)})))}),[n,c,l]),d=s(a),u="unpinning"===n?"fa-sync-alt fa-spin":"fa-thumbtack",p="deleting"===n?"fa-sync-alt fa-spin":"fa-minus";return(0,t.createElement)("div",{className:"ptc-TaskActions"},(0,t.createElement)("a",{href:d,target:"_asana"},(0,t.createElement)("button",{title:"View in Asana",className:"view",type:"button"},(0,t.createElement)("i",{className:"fas fa-link"}))),(0,t.createElement)("button",{title:"Unpin from Site",className:"unpin",type:"button",onClick:()=>r(a),disabled:!!n},(0,t.createElement)("i",{className:`fas ${u}`})),(0,t.createElement)("button",{title:"Delete from Asana",className:"delete",type:"button",onClick:()=>m(a),disabled:!!n},(0,t.createElement)("i",{className:`fas ${p}`})))}const{useState:I,useCallback:O,useContext:P}=wp.element;function j(e){let{task:a}=e;const[n,s]=I(!1),{isCriticalTask:o,completeTask:i,setTaskProcessingStatus:l}=P(k),c=O((t=>{a.processingStatus?console.error(`Rejected handleMarkComplete. Currently ${a.processingStatus} task ${t}.`):(l(t,"completing"),i(t).then((e=>{l(t,!1)})))}),[a.processingStatus,l,i]),r=O((()=>{a.notes&&s(!n)}),[a,n,s]),m=n?"fas":"far";let d=null;a.assignee&&(d=window.PTCCompletionist.users[a.assignee.gid]?window.PTCCompletionist.users[a.assignee.gid].data.display_name:"(Not Connected)");let u="";o(a)&&(u+=" --is-critical"),!0===a.completed&&(u+=" --is-complete"),a.processingStatus&&(u+=` --is-processing --is-${a.processingStatus}`);const p="completing"===a.processingStatus?"fa-sync-alt fa-spin":"fa-check",h=new Date(a.due_on).toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric"});return(0,t.createElement)("div",{className:"ptc-TaskRow"+u},(0,t.createElement)("button",{title:"Mark Complete",className:"mark-complete",type:"button",onClick:()=>c(a.gid),disabled:!!a.processingStatus},(0,t.createElement)("i",{className:`fas ${p}`})),(0,t.createElement)("div",{className:"body"},(0,t.createElement)("p",{className:"name",onClick:r},a.name,a.notes&&(0,t.createElement)("i",{className:`${m} fa-sticky-note`})),(0,t.createElement)("div",{className:"details"},d&&(0,t.createElement)("p",{className:"assignee"},(0,t.createElement)("i",{class:"fas fa-user"})," ",d),a.due_on&&(0,t.createElement)("p",{className:"due"},(0,t.createElement)("i",{className:"fas fa-clock"})," ",h)),n&&(0,t.createElement)("p",{className:"description"},a.notes)),(0,t.createElement)("div",{className:"actions"},(0,t.createElement)("a",{className:"cta-button",href:a.action_link.href,target:a.action_link.target},a.action_link.label," ",(0,t.createElement)("i",{className:"fas fa-long-arrow-alt-right"})),(0,t.createElement)(L,{taskGID:a.gid,processingStatus:a.processingStatus})))}function M(e){let{tasks:a}=e;const n=a.map((e=>(0,t.createElement)(j,{key:e.gid,task:e})));return(0,t.createElement)("div",{className:"ptc-TaskList"},n)}const{useState:x,useCallback:R,useMemo:F,useContext:U,useEffect:V}=wp.element;function $(e){let{limit:a,tasks:n}=e;const[s,o]=x(1),i=F((()=>Math.ceil(n.length/a)),[n,a]),l=R((t=>{o(t<=1?1:t>=i?i:t)}),[s,o,i]);V((()=>{l(s)}),[n]);const c=Math.max(0,(s-1)*a),r=n.slice(c,s*a),m=[];for(let e=1;e<=i;++e)m.push((0,t.createElement)("button",{className:"num",type:"button",title:`Page ${e}`,disabled:e===s,onClick:()=>l(e)},e));return(0,t.createElement)("div",{className:"ptc-TaskListPaginated"},(0,t.createElement)(M,{tasks:r}),(0,t.createElement)("nav",{className:"pagination"},(0,t.createElement)("button",{className:"prev",type:"button",title:"Previous Page",disabled:1===s,onClick:()=>l(s-1)},(0,t.createElement)("i",{className:"fas fa-angle-left"})),m,(0,t.createElement)("button",{className:"next",type:"button",title:"Next Page",disabled:i===s,onClick:()=>l(s+1)},(0,t.createElement)("i",{className:"fas fa-angle-right"}))))}const{useContext:B,useState:q,useEffect:Q}=wp.element;function G(){const{tasks:e}=B(k),[a,n]=q(e);return Q((()=>n(e)),[e,n]),(0,t.createElement)("div",{className:"ptc-PTCCompletionistTasksDashboardWidget"},(0,t.createElement)(C,{tasks:e}),(0,t.createElement)(y,{tasks:e,onChange:(t,e)=>n(e)}),(0,t.createElement)($,{limit:3,tasks:a}))}const{render:H}=wp.element;jQuery((function(e){try{const e=document.getElementById("ptc-completionist-automations-root");null!==e&&H((0,t.createElement)(h,null),e)}catch(t){console.error(t)}})),document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("ptc-PTCCompletionistTasksDashboardWidget");null!==e&&H((0,t.createElement)(f,null,(0,t.createElement)(G,null)),e)}))}();